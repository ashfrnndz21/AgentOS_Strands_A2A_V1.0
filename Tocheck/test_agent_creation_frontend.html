<!DOCTYPE html>
<html>
<head>
    <title>Agent Creation Debug Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1a1a1a; 
            color: white; 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #333; 
            border-radius: 8px;
            background: #2a2a2a;
        }
        .form-group { 
            margin: 10px 0; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        input, textarea, select { 
            width: 100%; 
            padding: 8px; 
            background: #333; 
            border: 1px solid #555; 
            color: white; 
            border-radius: 4px;
        }
        button { 
            padding: 10px 20px; 
            background: #6366f1; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { 
            background: #5855eb; 
        }
        button:disabled { 
            background: #555; 
            cursor: not-allowed; 
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        #result { 
            margin-top: 20px; 
            padding: 10px; 
            border-radius: 4px; 
            background: #333;
        }
    </style>
</head>
<body>
    <h1>üîß Agent Creation Debug Test</h1>
    
    <div class="test-section">
        <h2>Backend Connection Test</h2>
        <button onclick="testBackend()">Test Backend Connection</button>
        <div id="backendResult"></div>
    </div>
    
    <div class="test-section">
        <h2>Create Test Agent</h2>
        <form id="agentForm">
            <div class="form-group">
                <label>Agent Name:</label>
                <input type="text" id="name" value="Test Agent" required>
            </div>
            
            <div class="form-group">
                <label>Role:</label>
                <input type="text" id="role" value="Test Specialist" required>
            </div>
            
            <div class="form-group">
                <label>Description:</label>
                <textarea id="description" rows="3">A test agent for debugging purposes</textarea>
            </div>
            
            <div class="form-group">
                <label>Model:</label>
                <select id="model" required>
                    <option value="mistral">mistral</option>
                    <option value="phi3">phi3</option>
                    <option value="llama3.2">llama3.2</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Personality:</label>
                <textarea id="personality" rows="3" required>Professional, analytical, and helpful. I provide clear and detailed responses.</textarea>
            </div>
            
            <div class="form-group">
                <label>Expertise:</label>
                <textarea id="expertise" rows="3" required>testing, debugging, analysis, problem-solving</textarea>
            </div>
            
            <button type="button" onclick="createAgent()" id="createBtn">Create Agent</button>
        </form>
        
        <div id="result"></div>
    </div>
    
    <div class="test-section">
        <h2>List Existing Agents</h2>
        <button onclick="listAgents()">List Document Agents</button>
        <div id="agentsList"></div>
    </div>

    <script>
        async function testBackend() {
            const resultDiv = document.getElementById('backendResult');
            resultDiv.innerHTML = '<span class="info">Testing backend connection...</span>';
            
            try {
                const response = await fetch('http://localhost:8000/api/health');
                if (response.ok) {
                    resultDiv.innerHTML = '<span class="success">‚úÖ Backend is running and accessible</span>';
                } else {
                    resultDiv.innerHTML = `<span class="error">‚ùå Backend responded with status: ${response.status}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Cannot connect to backend: ${error.message}</span>`;
            }
        }
        
        async function createAgent() {
            const resultDiv = document.getElementById('result');
            const createBtn = document.getElementById('createBtn');
            
            // Disable button and show loading
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';
            resultDiv.innerHTML = '<span class="info">Creating agent...</span>';
            
            // Collect form data
            const formData = {
                name: document.getElementById('name').value,
                role: document.getElementById('role').value,
                description: document.getElementById('description').value,
                model: document.getElementById('model').value,
                personality: document.getElementById('personality').value,
                expertise: document.getElementById('expertise').value,
                document_preferences: {
                    analysis_style: 'detailed',
                    citation_style: 'professional',
                    response_format: 'structured'
                }
            };
            
            console.log('Sending agent data:', formData);
            
            try {
                const response = await fetch('http://localhost:8000/api/document-agents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Success result:', result);
                    resultDiv.innerHTML = `
                        <span class="success">‚úÖ Agent created successfully!</span><br>
                        <strong>Agent ID:</strong> ${result.agent.id}<br>
                        <strong>Name:</strong> ${result.agent.name}<br>
                        <strong>Role:</strong> ${result.agent.role}
                    `;
                } else {
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                    }
                    
                    console.error('Error response:', errorMessage);
                    resultDiv.innerHTML = `<span class="error">‚ùå Failed to create agent: ${errorMessage}</span>`;
                }
            } catch (error) {
                console.error('Request failed:', error);
                resultDiv.innerHTML = `<span class="error">‚ùå Request failed: ${error.message}</span>`;
            } finally {
                // Re-enable button
                createBtn.disabled = false;
                createBtn.textContent = 'Create Agent';
            }
        }
        
        async function listAgents() {
            const resultDiv = document.getElementById('agentsList');
            resultDiv.innerHTML = '<span class="info">Loading agents...</span>';
            
            try {
                const response = await fetch('http://localhost:8000/api/agents/document-ready');
                
                if (response.ok) {
                    const data = await response.json();
                    const agents = data.agents || [];
                    
                    if (agents.length === 0) {
                        resultDiv.innerHTML = '<span class="info">No document-ready agents found</span>';
                    } else {
                        let html = `<span class="success">Found ${agents.length} agents:</span><br><br>`;
                        agents.forEach(agent => {
                            html += `
                                <div style="border: 1px solid #555; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                    <strong>${agent.name}</strong> - ${agent.role}<br>
                                    <small>Model: ${agent.model} | Source: ${agent.source}</small>
                                </div>
                            `;
                        });
                        resultDiv.innerHTML = html;
                    }
                } else {
                    resultDiv.innerHTML = `<span class="error">‚ùå Failed to load agents: ${response.status}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Request failed: ${error.message}</span>`;
            }
        }
        
        // Test backend connection on page load
        window.onload = function() {
            testBackend();
        };
    </script>
</body>
</html>